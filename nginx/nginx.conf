user  nginx;
worker_processes  auto;

events { worker_connections 1024; }

http {
  include       /etc/nginx/mime.types;
  default_type  application/octet-stream;

  # Basic IO tuning
  sendfile on;
  tcp_nopush on;
  tcp_nodelay on;
  keepalive_timeout 65;

  # Logs
  access_log /var/log/nginx/access.log;
  error_log  /var/log/nginx/error.log warn;

  # --- Upstreams (Docker service names resolve on the shared network) ---
  upstream weather_upstream {
    server weather:5000;
    keepalive 16;
  }

  upstream sliver_upstream {
    # Sliver HTTP listener must be running on :8080 with profile 'current'
    server sliver:8080;
    keepalive 32;
  }

  # Optional: handle WebSocket Upgrade headers when needed
  map $http_upgrade $connection_upgrade {
    default upgrade;
    ''      close;
  }

  # --- HTTP â†’ HTTPS redirect ---
  server {
    listen 80;
    listen [::]:80;
    server_name ubu.jon.devs;
    return 301 https://$host$request_uri;
  }

  # --- HTTPS site ---
  server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name ubu.jon.devs;

    # Certs
    ssl_certificate     /etc/nginx/certs/ubu.jon.devs.crt;
    ssl_certificate_key /etc/nginx/certs/ubu.jon.devs.key;

    # Sensible TLS defaults
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_prefer_server_ciphers on;
    ssl_session_timeout 1d;
    ssl_session_cache shared:SSL:10m;
    ssl_session_tickets off;

    # Optional security headers
    # add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;

    # ---- Landing -> weather UI ----
    location = / { return 302 /weather/; }

    # ---- Weather frontend (prefix) ----
    location /weather/ {
      proxy_pass http://weather_upstream/; # note trailing slash for prefix rewrite
      proxy_http_version 1.1;
      proxy_set_header Host              $host;
      proxy_set_header X-Real-IP         $remote_addr;
      proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_set_header Connection        "";
      proxy_read_timeout 3600s;
      proxy_send_timeout 3600s;
      send_timeout 3600s;
      proxy_buffering off;
      proxy_request_buffering off;
    }

    # ---- Weather API (no trailing slash) ----
    location /api/weather {
      proxy_pass http://weather_upstream;  # no trailing slash preserves URI as-is
      proxy_http_version 1.1;
      proxy_set_header Host              $host;
      proxy_set_header X-Real-IP         $remote_addr;
      proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_set_header Connection        "";
      proxy_read_timeout 3600s;
      proxy_send_timeout 3600s;
      send_timeout 3600s;
      proxy_buffering off;
      proxy_request_buffering off;
    }

    # ---- Sliver C2 path (must match your implant URI prefix) ----
    # Keep NO trailing slash in proxy_pass to preserve the full /api/current/... path
    location ^~ /api/current/ {
      proxy_pass http://sliver_upstream/;
      proxy_http_version 1.1;
      proxy_set_header Host              $host;
      proxy_set_header X-Real-IP         $remote_addr;
      proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_set_header Connection        "";
      proxy_read_timeout 3600s;
      proxy_send_timeout 3600s;
      send_timeout 3600s;
      proxy_buffering off;
      proxy_request_buffering off;

      # If Sliver ever uses websockets on this path, these help:
      proxy_set_header Upgrade           $http_upgrade;
      proxy_set_header Connection        $connection_upgrade;
    }

    # Everything else closed off (optional)
    location / { return 404; }
  }
}
